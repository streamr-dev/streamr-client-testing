language: java
os: linux
dist: xenial
jdk:
- openjdk8
services:
- docker
branches:
  only:
  - master
  - "/^v\\d+\\.\\d+(\\.\\d+)?(-\\S*)?$/"
git:
  submodules: false
env:
  global:
  - NODE_VERSION=12
before_install:
- curl -s http://get.sdkman.io | bash
- echo sdkman_auto_answer=true > ~/.sdkman/etc/config
- source "/home/travis/.sdkman/bin/sdkman-init.sh"
- sdk install grails 2.5.6
- nvm install $NODE_VERSION
jobs:
  include:
  - stage: Test Production clients
    name: Dev Env
    script:
    - sed -i "s/com.streamr:client:1.3.0/com.streamr:client:+/g" $TRAVIS_BUILD_DIR/build.gradle
    - 'sed -i "s/\"streamr-client\": \"\^3.1.2\"/\"streamr-client\":\"latest\"/g" $TRAVIS_BUILD_DIR/package.json'
    - cat $TRAVIS_BUILD_DIR/package.json
    - npm install
    - gradle fatjar
    - $TRAVIS_BUILD_DIR/.travis-scripts/start-docker-dev.sh
    - java -jar build/libs/client_testing-1.0-SNAPSHOT.jar -s stream-encrypted-shared-rotating-signed -m test
  - stage: Test Production clients
    name: Prod Env
    script:
    - sed -i "s/com.streamr:client:1.3.0/com.streamr:client:+/g" $TRAVIS_BUILD_DIR/build.gradle
    - 'sed -i "s/\"streamr-client\": \"\^3.1.2\"/\"streamr-client\":\"latest\"/g" $TRAVIS_BUILD_DIR/package.json'
    - cat $TRAVIS_BUILD_DIR/package.json
    - npm install
    - gradle fatjar
    - $TRAVIS_BUILD_DIR/.travis-scripts/start-docker-dev.sh production
    - java -jar build/libs/client_testing-1.0-SNAPSHOT.jar -s stream-encrypted-shared-rotating-signed -m test
notifications:
  slack:
    secure: SZudefNcd6zl6XBqmvMwwyfTLKL5Ne8RwClU5naotZWuHgy3Pg/+X6J+dIp73bgXZsYVpPXaZTgcyoexE4q3Ru2o5a20aUhIXC3lwmmp0n2Z9o2uCzJg7QeUjoxZqMOggnrQi7/ykwM/BR7epqSFqX4QXsJhGXY8ddBSnCEVoW90bx/A/vUuMikLwDJKC+5xIVcW42E4XtBfawZrORpecKbJkouqb4id6Kk7p5IH9OttHB3bTidgSTEw4lU9lxFAdvdmy78/tzbvkjRIscROuzOECVspmuyBQhJIgiIK98kyQ1avq8vN3WQ42vHjrCXC84J6hVfUutVD2cK5bM0no1m/sf5xb4WiVsfh4XdYJCh9cSMFEJYpxX/mPVEiM6ygi8DzG0C+Y0W45FZStO4vPzeAOKF7YnnLg8rVWh+PJRcSoauKcdVdMTMtTJHV6FoZZinUC5Mg6p5dthME4UWvcWiHdLCOBHN9D1zitqPYY7Pu6yLtjWxPvqjVdDE1RNKPFM4aNIa/TYGrYbdfbMZq1Tm0wO6lDvIoqdcCYuSdttgxVQkpVqq4WK9kJN+YsmS/rmNPb+CgFoKgf7cSW3VEXFgByNtbR2ZJF5BKmPdene1univLXfuKpqo2Cbd0QKdnAVhuS/ryyeKo1PTQMy3PK9JNyxrwHBUMe55zCIfZfe0=
  if: branch = master
  on_success: change
  on_failure: always
  on_pull_requests: false